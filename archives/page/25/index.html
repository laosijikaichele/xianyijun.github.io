
<!DOCTYPE html>
<html lang="zh-Hans">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="枯叶未凋零">
    <title>Archives - 枯叶未凋零</title>
    <meta name="author" content="冼毅俊">
    
    
    
    <meta name="description" content="枯叶未凋零的个人博客，记录，积累，分享">
<meta property="og:type" content="blog">
<meta property="og:title" content="枯叶未凋零">
<meta property="og:url" content="http://xianyijun.github.io/archives/page/25/index.html">
<meta property="og:site_name" content="枯叶未凋零">
<meta property="og:description" content="枯叶未凋零的个人博客，记录，积累，分享">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="枯叶未凋零">
<meta name="twitter:description" content="枯叶未凋零的个人博客，记录，积累，分享">
    
    
        
    
    
        <meta property="og:image" content="http://xianyijun.github.io/assets/images/avatar_01.jpg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/font-awesome.css">
    <link rel="stylesheet" href="/assets/css/jquery.fancybox.css">
    <link rel="stylesheet" href="/assets/css/jquery.fancybox-thumbs.css">
    <link rel="stylesheet" href="/assets/css/tranquilpeak.css">
    <!--STYLES END-->
    
    
    <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?d7a77056cb6c66982de5797b0470724d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">枯叶未凋零</a>
    </h1>
    
        
            <a  class="header-right-icon st-search-show-outputs"
                href="#search">
        
        
            <i class="fa fa-lg fa-search"></i>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    
        <div class="sidebar-profile">
            <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/avatar_01.jpg"/>
            </a>
            <span class="sidebar-profile-name">冼毅俊</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-circle-thin"></i>
                    <span class="sidebar-button-desc">Home</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bars"></i>
                    <span class="sidebar-button-desc">Archives</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">Tags</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-terminal"></i>
                    <span class="sidebar-button-desc">About</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/xianyijun" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/link"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-at"></i>
                    <span class="sidebar-button-desc">Links</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    

<section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2016/05/11/Tomcat请求处理的过程分析/">
                            Tomcat请求处理的过程分析
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" content="Wed May 11 2016 20:51:51 GMT+0800">
	
		    May 11, 2016
    	
    </time>
    
</div>
            </div>
            
            
                <div class="postShorten-content" itemprop="articleBody">
                    <p>[toc]</p>
<h1 id="Tomcat请求处理的过程分析"><a href="#Tomcat请求处理的过程分析" class="headerlink" title="Tomcat请求处理的过程分析"></a><strong>Tomcat请求处理的过程分析</strong></h1><h2 id="Tomcat启动"><a href="#Tomcat启动" class="headerlink" title="Tomcat启动"></a><strong>Tomcat启动</strong></h2><p>Tomcat启动是以Bootstrap的main方法为入口类。<br>在加载Boostrap的时候，首先会执行Bootstrap的内部静态代码块，会对userDir、homeFile、baseFile属性进行初始化与设置。<br>main方法首先daemon进行非空判断，daemon是Bootstrap类型的成员变量，初始值为null，所有会创建一个Bootstrap对象，调用init方法，完成之后设置为daemon。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (daemon == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Don't set daemon until init() has completed</span></span><br><span class="line">        Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bootstrap.init();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            handleThrowable(t);</span><br><span class="line">            t.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        daemon = bootstrap;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String command = <span class="string">"start"</span>;</span><br><span class="line">        <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            command = args[args.length - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (command.equals(<span class="string">"startd"</span>)) &#123;</span><br><span class="line">            args[args.length - <span class="number">1</span>] = <span class="string">"start"</span>;</span><br><span class="line">            daemon.load(args);</span><br><span class="line">            daemon.start();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"stopd"</span>)) &#123;</span><br><span class="line">            args[args.length - <span class="number">1</span>] = <span class="string">"stop"</span>;</span><br><span class="line">            daemon.stop();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"start"</span>)) &#123;</span><br><span class="line">            daemon.setAwait(<span class="keyword">true</span>);</span><br><span class="line">            daemon.load(args);</span><br><span class="line">            daemon.start();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"stop"</span>)) &#123;</span><br><span class="line">            daemon.stopServer(args);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"configtest"</span>)) &#123;</span><br><span class="line">            daemon.load(args);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span>==daemon.getServer()) &#123;</span><br><span class="line">                System.exit(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.warn(<span class="string">"Bootstrap: command \""</span> + command + <span class="string">"\" does not exist."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> InvocationTargetException &amp;&amp;</span><br><span class="line">                t.getCause() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            t = t.getCause();</span><br><span class="line">        &#125;</span><br><span class="line">        handleThrowable(t);</span><br><span class="line">        t.printStackTrace();</span><br><span class="line">        System.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Tomcat初始化"><a href="#Tomcat初始化" class="headerlink" title="Tomcat初始化"></a><strong>Tomcat初始化</strong></h2><p>在init方法中设置catalina.base和catalina.home系统属性进行设置，然后创建和初始化commonClassLoader、catalinaClassLoader和shareClassLoader类加载器，然后通过反射创建一个org.apache.catalina.startup.Catalina类型的实例，设置为catalinaDomain，然后调用setParentClassLoader方法将shareClassLoader作为Catalina的父类加载器。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> public void init() throws Exception &#123;</span><br><span class="line">    initClassLoaders();</span><br><span class="line">    Thread.currentThread().setContextClassLoader(catalinaLoader);</span><br><span class="line">    SecurityClassLoad.securityClassLoad(catalinaLoader);</span><br><span class="line">    // Load our startup class and call its process() method</span><br><span class="line">    if (log.isDebugEnabled())</span><br><span class="line">        log.debug(&quot;Loading startup class&quot;);</span><br><span class="line">    Class&lt;?&gt; startupClass =</span><br><span class="line">        catalinaLoader.loadClass</span><br><span class="line">        (&quot;org.apache.catalina.startup.Catalina&quot;);</span><br><span class="line">    Object startupInstance = startupClass.newInstance();</span><br><span class="line">    if (log.isDebugEnabled())</span><br><span class="line">        log.debug(&quot;Setting startup class properties&quot;);</span><br><span class="line">    String methodName = &quot;setParentClassLoader&quot;;</span><br><span class="line">    Class&lt;?&gt; paramTypes[] = new Class[1];</span><br><span class="line">    paramTypes[0] = Class.forName(&quot;java.lang.ClassLoader&quot;);</span><br><span class="line">    Object paramValues[] = new Object[1];</span><br><span class="line">    paramValues[0] = sharedLoader;</span><br><span class="line">    Method method =startupInstance.getClass().getMethod(methodName, paramTypes);</span><br><span class="line">    method.invoke(startupInstance, paramValues);</span><br><span class="line">    catalinaDaemon = startupInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="解析web-xml和初始化Server"><a href="#解析web-xml和初始化Server" class="headerlink" title="解析web.xml和初始化Server"></a><strong>解析web.xml和初始化Server</strong></h3><p>然后根据用户传入的参数进行判断，执行对应方法，默认为start。<br>我们启动tomcat的话，执行的分支肯定是start。<br>首先调用Bootstrap的load方法，load主要是通过反射去调用之前设置catalinaDaemon的load方法和start方法。<br>Catalina的load方法主要是创建一个Digester对tomcat的server.xml配置文件进行解析和对相关catainer容器对象进行创建，<br>然后对Server的部分属性进行设置和调用Server的init方法进行调用。Server的默认实现为StandardServer。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line">    initDirs();</span><br><span class="line">    initNaming();</span><br><span class="line">    Digester digester = createStartDigester();</span><br><span class="line">    InputSource inputSource = <span class="keyword">null</span>;</span><br><span class="line">    InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">    File file = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            file = configFile();</span><br><span class="line">            inputStream = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">            inputSource = <span class="keyword">new</span> InputSource(file.toURI().toURL().toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(sm.getString(<span class="string">"catalina.configFail"</span>, file), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (inputStream == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                inputStream = getClass().getClassLoader()</span><br><span class="line">                    .getResourceAsStream(getConfigFile());</span><br><span class="line">                inputSource = <span class="keyword">new</span> InputSource</span><br><span class="line">                    (getClass().getClassLoader()</span><br><span class="line">                     .getResource(getConfigFile()).toString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(sm.getString(<span class="string">"catalina.configFail"</span>,</span><br><span class="line">                            getConfigFile()), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (inputStream == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                inputStream = getClass().getClassLoader()</span><br><span class="line">                        .getResourceAsStream(<span class="string">"server-embed.xml"</span>);</span><br><span class="line">                inputSource = <span class="keyword">new</span> InputSource</span><br><span class="line">                (getClass().getClassLoader()</span><br><span class="line">                        .getResource(<span class="string">"server-embed.xml"</span>).toString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(sm.getString(<span class="string">"catalina.configFail"</span>,</span><br><span class="line">                            <span class="string">"server-embed.xml"</span>), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (inputStream == <span class="keyword">null</span> || inputSource == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>  (file == <span class="keyword">null</span>) &#123;</span><br><span class="line">                log.warn(sm.getString(<span class="string">"catalina.configFail"</span>,</span><br><span class="line">                        getConfigFile() + <span class="string">"] or [server-embed.xml]"</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.warn(sm.getString(<span class="string">"catalina.configFail"</span>,</span><br><span class="line">                        file.getAbsolutePath()));</span><br><span class="line">                <span class="keyword">if</span> (file.exists() &amp;&amp; !file.canRead()) &#123;</span><br><span class="line">                    log.warn(<span class="string">"Permissions incorrect, read permission is not allowed on the file."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            inputSource.setByteStream(inputStream);</span><br><span class="line">            digester.push(<span class="keyword">this</span>);</span><br><span class="line">            digester.parse(inputSource);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SAXParseException spe) &#123;</span><br><span class="line">            log.warn(<span class="string">"Catalina.start using "</span> + getConfigFile() + <span class="string">": "</span> +</span><br><span class="line">                    spe.getMessage());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(<span class="string">"Catalina.start using "</span> + getConfigFile() + <span class="string">": "</span> , e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                inputStream.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    getServer().setCatalina(<span class="keyword">this</span>);</span><br><span class="line">    getServer().setCatalinaHome(Bootstrap.getCatalinaHomeFile());</span><br><span class="line">    getServer().setCatalinaBase(Bootstrap.getCatalinaBaseFile());</span><br><span class="line"></span><br><span class="line">    initStreams();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        getServer().init();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Boolean.getBoolean(<span class="string">"org.apache.catalina.startup.EXIT_ON_INIT_FAILURE"</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> java.lang.Error(e);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">"Catalina.start"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> t2 = System.nanoTime();</span><br><span class="line">    <span class="keyword">if</span>(log.isInfoEnabled()) &#123;</span><br><span class="line">        log.info(<span class="string">"Initialization processed in "</span> + ((t2 - t1) / <span class="number">1000000</span>) + <span class="string">" ms"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StandardServer的init方法是在LifecycleBase中实现的。init、start、stop、destory方法是在Lifecycle接口中定义的，LifecycleBase抽象类通过模板模式实现了对应的方法和进行管理，提供initInternal、startInternal、stopInternal、destroyInternal等钩子方法让子类来实现。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!state.equals(LifecycleState.NEW)) &#123;</span><br><span class="line">        invalidTransition(Lifecycle.BEFORE_INIT_EVENT);</span><br><span class="line">    &#125;</span><br><span class="line">    setStateInternal(LifecycleState.INITIALIZING, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        initInternal();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        setStateInternal(LifecycleState.FAILED, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(</span><br><span class="line">                sm.getString(<span class="string">"lifecycleBase.initFail"</span>,toString()), t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setStateInternal(LifecycleState.INITIALIZED, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>init方法主要是对LifecycleState进行判断与设置，并调用对应子类的initInternal方法。<br>StandardServer的initInternal方法主要是注册全局StringCache、MBeanFactory、namingResource，然后调用CommonClassLoader和shareClassLoader来加载extension的jar包，最后循环调用子容器service(默认为StandardService)的init方法。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">protected void initInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">    super.initInternal();</span><br><span class="line"></span><br><span class="line">    onameStringCache = register(new StringCache(), "type=StringCache");</span><br><span class="line"></span><br><span class="line">    MBeanFactory factory = new MBeanFactory();</span><br><span class="line">    factory.setContainer(this);</span><br><span class="line">    onameMBeanFactory = register(factory, "type=MBeanFactory");</span><br><span class="line"></span><br><span class="line">    globalNamingResources.init();</span><br><span class="line"></span><br><span class="line">    if (getCatalina() != null) &#123;</span><br><span class="line">        ClassLoader cl = getCatalina().getParentClassLoader();</span><br><span class="line">        while (cl != null &amp;&amp; cl != ClassLoader.getSystemClassLoader()) &#123;</span><br><span class="line">            if (cl instanceof URLClassLoader) &#123;</span><br><span class="line">                URL[] urls = ((URLClassLoader) cl).getURLs();</span><br><span class="line">                for (URL url : urls) &#123;</span><br><span class="line">                    if (url.getProtocol().equals("file")) &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            File f = new File (url.toURI());</span><br><span class="line">                            if (f.isFile() &amp;&amp;</span><br><span class="line">                                    f.getName().endsWith(".jar")) &#123;</span><br><span class="line">                                ExtensionValidator.addSystemResource(f);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; catch (URISyntaxException e) &#123;</span><br><span class="line">                        &#125; catch (IOException e) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            cl = cl.getParent();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    for (int i = 0; i &lt; services.length; i++) &#123;</span><br><span class="line">        services[i].init();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">```    </span><br><span class="line">### **初始化Service** ###</span><br><span class="line">StandardService的initInternal方法,主要是初始化Executor、container(Engine)、mapperListenner和对connectors进行循环初始化。</span><br><span class="line">```java</span><br><span class="line">protected void initInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">    super.initInternal();</span><br><span class="line"></span><br><span class="line">    if (container != null) &#123;</span><br><span class="line">        container.init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (Executor executor : findExecutors()) &#123;</span><br><span class="line">        if (executor instanceof JmxEnabled) &#123;</span><br><span class="line">            ((JmxEnabled) executor).setDomain(getDomain());</span><br><span class="line">        &#125;</span><br><span class="line">        executor.init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mapperListener.init();</span><br><span class="line"></span><br><span class="line">    synchronized (connectorsLock) &#123;</span><br><span class="line">        for (Connector connector : connectors) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                connector.init();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                String message = sm.getString(</span><br><span class="line">                        "standardService.connector.initFailed", connector);</span><br><span class="line">                log.error(message, e);</span><br><span class="line"></span><br><span class="line">                if (Boolean.getBoolean("org.apache.catalina.startup.EXIT_ON_INIT_FAILURE"))</span><br><span class="line">                    throw new LifecycleException(message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="初始化Engine"><a href="#初始化Engine" class="headerlink" title="初始化Engine"></a><strong>初始化Engine</strong></h3><p>Engine的initInternal主要对确保至少存在一个realm，默认创建NullRealm。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">	getRealm();</span><br><span class="line">	<span class="keyword">super</span>.initInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Realm <span class="title">getRealm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Realm configured = <span class="keyword">super</span>.getRealm();</span><br><span class="line">	<span class="comment">// If no set realm has been called - default to NullRealm</span></span><br><span class="line">	<span class="comment">// This can be overridden at engine, context and host level</span></span><br><span class="line">	<span class="keyword">if</span> (configured == <span class="keyword">null</span>) &#123;</span><br><span class="line">		configured = <span class="keyword">new</span> NullRealm();</span><br><span class="line">		<span class="keyword">this</span>.setRealm(configured);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> configured;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化Connector"><a href="#初始化Connector" class="headerlink" title="初始化Connector"></a><strong>初始化Connector</strong></h3><p>Connector的initInternal方法主要是设置parseBodyMethod的默认值（POST）、初始化CoyoteAdapter和protocolHandler<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.initInternal();</span><br><span class="line">	adapter = <span class="keyword">new</span> CoyoteAdapter(<span class="keyword">this</span>);</span><br><span class="line">	protocolHandler.setAdapter(adapter);</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">null</span> == parseBodyMethodsSet) &#123;</span><br><span class="line">		setParseBodyMethods(getParseBodyMethods());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (protocolHandler.isAprRequired() &amp;&amp; !AprLifecycleListener.isAprAvailable()) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(</span><br><span class="line">				sm.getString(<span class="string">"coyoteConnector.protocolHandlerNoApr"</span>, getProtocolHandlerClassName()));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		protocolHandler.init();</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(sm.getString(<span class="string">"coyoteConnector.protocolHandlerInitializationFailed"</span>), e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ProtocolHandler的init是在AbstractProtocol实现，主要调用EndPoint的init方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getLog().isInfoEnabled())</span><br><span class="line">        getLog().info(sm.getString(<span class="string">"abstractProtocolHandler.init"</span>,getName()));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oname == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Component not pre-registered so register it</span></span><br><span class="line">        oname = createObjectName();</span><br><span class="line">        <span class="keyword">if</span> (oname != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(<span class="keyword">this</span>, oname, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.domain != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tpOname = <span class="keyword">new</span> ObjectName(domain + <span class="string">":"</span> +<span class="string">"type=ThreadPool,name="</span> + getName());</span><br><span class="line">            Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(endpoint,tpOname, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            getLog().error(sm.getString(</span><br><span class="line">                    <span class="string">"abstractProtocolHandler.mbeanRegistrationFailed"</span>,</span><br><span class="line">                    tpOname, getName()), e);</span><br><span class="line">        &#125;</span><br><span class="line">        rgOname=<span class="keyword">new</span> ObjectName(domain +</span><br><span class="line">                <span class="string">":type=GlobalRequestProcessor,name="</span> + getName());</span><br><span class="line">        Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(</span><br><span class="line">                getHandler().getGlobal(), rgOname, <span class="keyword">null</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String endpointName = getName();</span><br><span class="line">    endpoint.setName(endpointName.substring(<span class="number">1</span>, endpointName.length()-<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        endpoint.init();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        getLog().error(sm.getString(<span class="string">"abstractProtocolHandler.initError"</span>,</span><br><span class="line">                getName()), ex);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>EndPoint的init方法主要是根据bingOnInit变量是否调用bind方法，bind主要是由子类来实习的。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public final void init() throws Exception &#123;</span><br><span class="line">    testServerCipherSuitesOrderSupport();</span><br><span class="line">    if (bindOnInit) &#123;</span><br><span class="line">        bind();</span><br><span class="line">        bindState = BindState.BOUND_ON_INIT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">```    </span><br><span class="line">---</span><br><span class="line">### **启动Catalina** ###</span><br><span class="line">在对所有的组件进行init完成之后，接下来就是调用Catalina的start方法进行启动了。跟init差不多，都是父组件在完成自身的start方法之后，循环对子组件进行start。</span><br><span class="line">Catalina的start方法主要是对StandardServer的start方法进行调用和注册shutdownHook。在Bootstrap中调用setAwait利用反射将daemon的await值设置为true。await将调用main方法的线程进行阻塞，防止main方法退出，JVM会在所有非Daemon(守护)线程都退出之后，杀死所有Daemon线程，退出程序。</span><br><span class="line">await方法主要是创建一个监听指定端口的ServerSocket，当有请求过来的时候，会对特定的SHUTDOWN字符串进行比对，如果相等的话，就会退出循环，方法返回。main线程就会退出，程序也就结束了。</span><br><span class="line">shutDownHook是一个关闭钩子，可以通过传入一个Thread的实例调用addShutdownHook方法，来指定当程序关闭之前需要进行什么动作或者采取措施，一般是用来释放资源的。</span><br></pre></td></tr></table></figure></p>
<p> public void start() {</p>
<pre><code>if (getServer() == null) {
    load();
}

if (getServer() == null) {
    return;
}

long t1 = System.nanoTime();

try {
    getServer().start();
} catch (LifecycleException e) {
    log.fatal(sm.getString(&quot;catalina.serverStartFail&quot;), e);
    try {
        getServer().destroy();
    } catch (LifecycleException e1) {
        log.debug(&quot;destroy() failed for failed Server &quot;, e1);
    }
    return;
}

long t2 = System.nanoTime();
if (useShutdownHook) {
    if (shutdownHook == null) {
        shutdownHook = new CatalinaShutdownHook();
    }
    Runtime.getRuntime().addShutdownHook(shutdownHook);
    LogManager logManager = LogManager.getLogManager();
    if (logManager instanceof ClassLoaderLogManager) {
        ((ClassLoaderLogManager) logManager).setUseShutdownHook(
                false);
    }
}

if (await) {
    await();
    stop();
}
</code></pre><p>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">### **启动Server** ###</span><br><span class="line">StandardServer的startInternal方法主要是对globalNamingResources（J2EE标准的JNDI）进行启动和子容器service进行循环调用start方法。</span><br><span class="line">```java</span><br><span class="line">protected void startInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">    fireLifecycleEvent(CONFIGURE_START_EVENT, null);</span><br><span class="line">    setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">    globalNamingResources.start();</span><br><span class="line"></span><br><span class="line">    // Start our defined Services</span><br><span class="line">    synchronized (servicesLock) &#123;</span><br><span class="line">        for (int i = 0; i &lt; services.length; i++) &#123;</span><br><span class="line">            services[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="启动Service"><a href="#启动Service" class="headerlink" title="启动Service"></a><strong>启动Service</strong></h3><p>Standard的startInternal方法主要对Executor、Connector等嵌套组件和container(Engine)进行start方法调用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">    setState(LifecycleState.STARTING);</span><br><span class="line">    <span class="keyword">if</span> (container != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (container) &#123;</span><br><span class="line">            container.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (executors) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Executor executor: executors) &#123;</span><br><span class="line">            executor.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mapperListener.start();</span><br><span class="line">    <span class="keyword">synchronized</span> (connectorsLock) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Connector connector: connectors) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (connector.getState() != LifecycleState.FAILED) &#123;</span><br><span class="line">                    connector.start();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(sm.getString(</span><br><span class="line">                        <span class="string">"standardService.connector.startFailed"</span>,</span><br><span class="line">                        connector), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="启动Listener"><a href="#启动Listener" class="headerlink" title="启动Listener"></a><strong>启动Listener</strong></h3><p>MapperListener的startInternal主要注册host，在注册host的方法中会递归注册对应context和wrapper。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">	setState(LifecycleState.STARTING);</span><br><span class="line">	Engine engine = (Engine) service.getContainer();</span><br><span class="line">	<span class="keyword">if</span> (engine == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	findDefaultHost();</span><br><span class="line"></span><br><span class="line">	addListeners(engine);</span><br><span class="line"></span><br><span class="line">	Container[] conHosts = engine.findChildren();</span><br><span class="line">	<span class="keyword">for</span> (Container conHost : conHosts) &#123;</span><br><span class="line">		Host host = (Host) conHost;</span><br><span class="line">		<span class="keyword">if</span> (!LifecycleState.NEW.equals(host.getState())) &#123;</span><br><span class="line">			registerHost(host);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="启动Connector"><a href="#启动Connector" class="headerlink" title="启动Connector"></a><strong>启动Connector</strong></h3><p>Connector主要是启动protocolHandler，通过启动protocolHandler来委托调用启动endPoint。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (getPort() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(sm.getString(<span class="string">"coyoteConnector.invalidPort"</span>, Integer.valueOf(getPort())));</span><br><span class="line">	&#125;</span><br><span class="line">	setState(LifecycleState.STARTING);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		protocolHandler.start();</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		String errPrefix = <span class="string">""</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.service != <span class="keyword">null</span>) &#123;</span><br><span class="line">			errPrefix += <span class="string">"service.getName(): \""</span> + <span class="keyword">this</span>.service.getName() + <span class="string">"\"; "</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(errPrefix + +sm.getString(<span class="string">"coyoteConnector.protocolHandlerStartFailed"</span>),e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="启动EndPoint"><a href="#启动EndPoint" class="headerlink" title="启动EndPoint"></a><strong>启动EndPoint</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        endpoint.start();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>EndPoint的startInternal是个抽象方法，主要是由子类来实现。有AprEndpoint、JIoEndpoint、Nio2Endpoint、NioEndpoint四种，我用的是Tomcat8，主要使用的是NioEndPoint的，接下来主要是以NioEndPoint分析为主。<br>startInternal主要是启动worker线程池（Executor主要是用来执行SocketProcessor线程）、Poller线程(根据处理器数量来创建一定数目的轮询器)和Acceptor(接收者线程)。不过如果是JIOEndPoint的话，还会启动Async Timeout thread.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!running) &#123;</span><br><span class="line">        running = <span class="keyword">true</span>;</span><br><span class="line">        paused = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        processorCache = <span class="keyword">new</span> SynchronizedStack&lt;&gt;(SynchronizedStack.DEFAULT_SIZE,</span><br><span class="line">                socketProperties.getProcessorCache());</span><br><span class="line">        eventCache = <span class="keyword">new</span> SynchronizedStack&lt;&gt;(SynchronizedStack.DEFAULT_SIZE,</span><br><span class="line">                        socketProperties.getEventCache());</span><br><span class="line">        nioChannels = <span class="keyword">new</span> SynchronizedStack&lt;&gt;(SynchronizedStack.DEFAULT_SIZE,</span><br><span class="line">                socketProperties.getBufferPool());</span><br><span class="line">        <span class="keyword">if</span> ( getExecutor() == <span class="keyword">null</span> ) &#123;</span><br><span class="line">            createExecutor();</span><br><span class="line">        &#125;</span><br><span class="line">        initializeConnectionLatch();</span><br><span class="line">        pollers = <span class="keyword">new</span> Poller[getPollerThreadCount()];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;pollers.length; i++) &#123;</span><br><span class="line">            pollers[i] = <span class="keyword">new</span> Poller();</span><br><span class="line">            Thread pollerThread = <span class="keyword">new</span> Thread(pollers[i], getName() + <span class="string">"-ClientPoller-"</span>+i);</span><br><span class="line">            pollerThread.setPriority(threadPriority);</span><br><span class="line">            pollerThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">            pollerThread.start();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        startAcceptorThreads();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startAcceptorThreads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> count = getAcceptorThreadCount();</span><br><span class="line">    acceptors = <span class="keyword">new</span> Acceptor[count];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        acceptors[i] = createAcceptor();</span><br><span class="line">        String threadName = getName() + <span class="string">"-Acceptor-"</span> + i;</span><br><span class="line">        acceptors[i].setThreadName(threadName);</span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(acceptors[i], threadName);</span><br><span class="line">        t.setPriority(getAcceptorThreadPriority());</span><br><span class="line">        t.setDaemon(getDaemon());</span><br><span class="line">        t.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Socket对象转为内部Request"><a href="#Socket对象转为内部Request" class="headerlink" title="Socket对象转为内部Request"></a><strong>Socket对象转为内部Request</strong></h2><p>在tomcat启动之后，我们可以看到Tomcat是通过NioEndPoint的Acceptor来接收Socket链接，交由对应Processor来处理。<br>Acceptor的run中会一直循环直到接收到关闭命令为止，如果已经达到最大连接数通过调用countUpOrAwaitConnection方法让线程等待，当有请求进行连接的时候，会获取对应的Socket，然后调用setSocketOptions方法把socket添加到轮询器Poller中。</p>
<h3 id="Processor"><a href="#Processor" class="headerlink" title="Processor"></a><strong>Processor</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> errorDelay = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (running) &#123;</span><br><span class="line">            <span class="keyword">while</span> (paused &amp;&amp; running) &#123;</span><br><span class="line">                state = AcceptorState.PAUSED;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">50</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="comment">// Ignore</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!running) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            state = AcceptorState.RUNNING;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                countUpOrAwaitConnection();</span><br><span class="line">                SocketChannel socket = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    socket = serverSock.accept();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                    countDownConnection();</span><br><span class="line">                    errorDelay = handleExceptionWithDelay(errorDelay);</span><br><span class="line">                    <span class="keyword">throw</span> ioe;</span><br><span class="line">                &#125;</span><br><span class="line">                errorDelay = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (running &amp;&amp; !paused) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!setSocketOptions(socket)) &#123;</span><br><span class="line">                        countDownConnection();</span><br><span class="line">                        closeSocket(socket);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    countDownConnection();</span><br><span class="line">                    closeSocket(socket);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SocketTimeoutException sx) &#123;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException x) &#123;</span><br><span class="line">                <span class="keyword">if</span> (running) &#123;</span><br><span class="line">                    log.error(sm.getString(<span class="string">"endpoint.accept.fail"</span>), x);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (OutOfMemoryError oom) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    oomParachuteData = <span class="keyword">null</span>;</span><br><span class="line">                    releaseCaches();</span><br><span class="line">                &#125;<span class="keyword">catch</span> ( Throwable oomt ) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            System.err.println(oomParachuteMsg);</span><br><span class="line">                            oomt.printStackTrace();</span><br><span class="line">                        &#125;<span class="keyword">catch</span> (Throwable letsHopeWeDontGetHere)&#123;</span><br><span class="line">                            ExceptionUtils.handleThrowable(letsHopeWeDontGetHere);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;<span class="keyword">catch</span> (Throwable letsHopeWeDontGetHere)&#123;</span><br><span class="line">                        ExceptionUtils.handleThrowable(letsHopeWeDontGetHere);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        state = AcceptorState.ENDED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>setSocketOptions方法主要是对SocketChannel的参数进行设置，然后将SocketChannel注册到Poller中。<br>首先将SocketChannel设置为not-block，然后根据在server.xml的connector节点中的参数通过socketProperties的setProperties方法对socket进行设置，例如socket接收或者发送的窗口大小、心跳检查等，然后从NioChannels队列中获取NIoChannel对象，NioChannel是SocketChannel的一个封装，主要是用来屏蔽SSL TCP连接和普通连接的差异。<br>如果NioChannel为null的话，就创建NioChannel(分为SSL和普通连接两种情况)，需要传入SocketChannel和NioBufferHandler，否则的话需要对NioChannel进行reset和与SocketChannel进行关联。<br>最后通过getPoller0方法轮询当前的Poller数组，取出一个Poller调用register对NioChannel进行注册。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">setSocketOptions</span><span class="params">(SocketChannel socket)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Process the connection</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//disable blocking, APR style, we are gonna be polling it</span></span><br><span class="line">        socket.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        Socket sock = socket.socket();</span><br><span class="line">        socketProperties.setProperties(sock);</span><br><span class="line"></span><br><span class="line">        NioChannel channel = nioChannels.pop();</span><br><span class="line">        <span class="keyword">if</span> ( channel == <span class="keyword">null</span> ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sslContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">                SSLEngine engine = createSSLEngine();</span><br><span class="line">                <span class="keyword">int</span> appbufsize = engine.getSession().getApplicationBufferSize();</span><br><span class="line">                NioBufferHandler bufhandler = <span class="keyword">new</span> NioBufferHandler(Math.max(appbufsize,socketProperties.getAppReadBufSize()),</span><br><span class="line">                                                                   Math.max(appbufsize,socketProperties.getAppWriteBufSize()),</span><br><span class="line">                                                                   socketProperties.getDirectBuffer());</span><br><span class="line">                channel = <span class="keyword">new</span> SecureNioChannel(socket, engine, bufhandler, selectorPool);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// normal tcp setup</span></span><br><span class="line">                NioBufferHandler bufhandler = <span class="keyword">new</span> NioBufferHandler(socketProperties.getAppReadBufSize(),</span><br><span class="line">                                                                   socketProperties.getAppWriteBufSize(),</span><br><span class="line">                                                                   socketProperties.getDirectBuffer());</span><br><span class="line"></span><br><span class="line">                channel = <span class="keyword">new</span> NioChannel(socket, bufhandler);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            channel.setIOChannel(socket);</span><br><span class="line">            <span class="keyword">if</span> ( channel <span class="keyword">instanceof</span> SecureNioChannel ) &#123;</span><br><span class="line">                SSLEngine engine = createSSLEngine();</span><br><span class="line">                ((SecureNioChannel)channel).reset(engine);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                channel.reset();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        getPoller0().register(channel);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.error(<span class="string">""</span>,t);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable tt) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Tell to close the socket</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>register主要是将NioChannel封装成一个PollerEvent，然后加入到Poller的Events缓存队列中。<br>首先设置NioChannel的Poller，然后创建KeyAttachment对NioChannel进行封装和设置对应的参数，设置读操作为感兴趣操作。<br>然后从Poller中的事件缓存中取出一个PollerEvent，如果为null的话，传入NioChannel和KeyAttachment构建一个PollerEvent对象，否则的话对PollerEvent进行重置；最后将PollerEvent添加到Poller对象里的缓存事件队列，如果当前事件队列没有事件，就会唤醒当前阻塞的Selector。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> NioChannel socket)</span> </span>&#123;</span><br><span class="line">    socket.setPoller(<span class="keyword">this</span>);</span><br><span class="line">    KeyAttachment ka = <span class="keyword">new</span> KeyAttachment(socket);</span><br><span class="line">    ka.setPoller(<span class="keyword">this</span>);</span><br><span class="line">    ka.setTimeout(getSocketProperties().getSoTimeout());</span><br><span class="line">    ka.setKeepAliveLeft(NioEndpoint.<span class="keyword">this</span>.getMaxKeepAliveRequests());</span><br><span class="line">    ka.setSecure(isSSLEnabled());</span><br><span class="line">    PollerEvent r = eventCache.pop();</span><br><span class="line">    ka.interestOps(SelectionKey.OP_READ);<span class="comment">//this is what OP_REGISTER turns into.</span></span><br><span class="line">    <span class="keyword">if</span> ( r==<span class="keyword">null</span>) r = <span class="keyword">new</span> PollerEvent(socket,ka,OP_REGISTER);</span><br><span class="line">    <span class="keyword">else</span> r.reset(socket,ka,OP_REGISTER);</span><br><span class="line">    addEvent(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Acceptor是将接收到的Socket的封装成PollerEvent添加到Poller的事件缓存队列，然后Poller的run方法对事件进行处理。<br>每一Poller对象都会聚合一个Selector进行处理。<br>run循环中对Poller的状态进行判断，如果是paused的话，就会无限sleep，直到唤醒；如果是close的话，就会调用Events方法对事件队列的事件逐一取出并执行对应的事件线程，如果事件是PollerEvent的话，会将事件处理完成之后，将事件对象放到事件缓存eventCache中，否则如果事件队列为空的话，直接返回false。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">events</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    PollerEvent pe = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span> ( (pe = events.poll()) != <span class="keyword">null</span> ) &#123;</span><br><span class="line">        result = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            pe.run();</span><br><span class="line">            pe.reset();</span><br><span class="line">            <span class="keyword">if</span> (running &amp;&amp; !paused) &#123;</span><br><span class="line">                eventCache.push(pe);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> ( Throwable x ) &#123;</span><br><span class="line">            log.error(<span class="string">""</span>,x);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PollerEvent主要是向socket注册和更新感兴趣的事件。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> ( interestOps == OP_REGISTER ) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               socket.getIOChannel().register(socket.getPoller().getSelector(), SelectionKey.OP_READ, key);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">               log.error(<span class="string">""</span>, x);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">final</span> SelectionKey key = socket.getIOChannel().keyFor(socket.getPoller().getSelector());</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">boolean</span> cancel = <span class="keyword">false</span>;</span><br><span class="line">               <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">final</span> KeyAttachment att = (KeyAttachment) key.attachment();</span><br><span class="line">                   <span class="keyword">if</span> ( att!=<span class="keyword">null</span> ) &#123;</span><br><span class="line">                       att.access();<span class="comment">//to prevent timeout</span></span><br><span class="line">                       <span class="comment">//we are registering the key to start with, reset the fairness counter.</span></span><br><span class="line">                       <span class="keyword">int</span> ops = key.interestOps() | interestOps;</span><br><span class="line">                       att.interestOps(ops);</span><br><span class="line">                       key.interestOps(ops);</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       cancel = <span class="keyword">true</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   cancel = <span class="keyword">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> ( cancel ) socket.getPoller().cancelledKey(key,SocketStatus.ERROR);</span><br><span class="line">           &#125;<span class="keyword">catch</span> (CancelledKeyException ckx) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   socket.getPoller().cancelledKey(key,SocketStatus.DISCONNECT);</span><br><span class="line">               &#125;<span class="keyword">catch</span> (Exception ignore) &#123;&#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>如果没有close的话，会调用唤醒多路复用器的条件阀值wakeupCounter的getAndSet(-1)方法唤醒Selector，然后调用selector的非阻塞selectNow方法，否则的话调用Selector的select方法查看是否事件发生。<br>然后获取在Selector的selectionKey方法获取在Selector中已注册的Channel中已经就绪SelectionKey，然后对SelectionKey集合进行迭代处理。<br>在迭代处理中，首先获取SelectionKey的attachment(KeyAttachment)，然后更新通道最近一次事件发生的时间，调用remove方法将SelectionKey从set中移除，防止多次处理，最后调用processKey方法进行具体处理。最后通过timeout方法对超时进行处理，每执行一个select操作就去参看所有的通道是否超时，如果超时的话，就将对应的通道从Selector中移除。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (paused &amp;&amp; (!close) ) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">boolean</span> hasEvents = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (close) &#123;</span><br><span class="line">                events();</span><br><span class="line">                timeout(<span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    selector.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                    log.error(sm.getString(</span><br><span class="line">                            <span class="string">"endpoint.nio.selectorCloseFail"</span>), ioe);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                hasEvents = events();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ( !close ) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (wakeupCounter.getAndSet(-<span class="number">1</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        keyCount = selector.selectNow();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        keyCount = selector.select(selectorTimeout);</span><br><span class="line">                    &#125;</span><br><span class="line">                    wakeupCounter.set(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (close) &#123;</span><br><span class="line">                    events();</span><br><span class="line">                    timeout(<span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        selector.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                        log.error(sm.getString(</span><br><span class="line">                                <span class="string">"endpoint.nio.selectorCloseFail"</span>), ioe);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(x);</span><br><span class="line">                log.error(<span class="string">""</span>,x);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( keyCount == <span class="number">0</span> ) hasEvents = (hasEvents | events());</span><br><span class="line"></span><br><span class="line">            Iterator&lt;SelectionKey&gt; iterator =</span><br><span class="line">                keyCount &gt; <span class="number">0</span> ? selector.selectedKeys().iterator() : <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">while</span> (iterator != <span class="keyword">null</span> &amp;&amp; iterator.hasNext()) &#123;</span><br><span class="line">                SelectionKey sk = iterator.next();</span><br><span class="line">                KeyAttachment attachment = (KeyAttachment)sk.attachment();</span><br><span class="line">                <span class="keyword">if</span> (attachment == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    iterator.remove();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    attachment.access();</span><br><span class="line">                    iterator.remove();</span><br><span class="line">                    processKey(sk, attachment);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="comment">//while</span></span><br><span class="line">            timeout(keyCount,hasEvents);</span><br><span class="line">            <span class="keyword">if</span> ( oomParachute &gt; <span class="number">0</span> &amp;&amp; oomParachuteData == <span class="keyword">null</span> ) checkParachute();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OutOfMemoryError oom) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                oomParachuteData = <span class="keyword">null</span>;</span><br><span class="line">                releaseCaches();</span><br><span class="line">                log.error(<span class="string">""</span>, oom);</span><br><span class="line">            &#125;<span class="keyword">catch</span> ( Throwable oomt ) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.err.println(oomParachuteMsg);</span><br><span class="line">                    oomt.printStackTrace();</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Throwable letsHopeWeDontGetHere)&#123;</span><br><span class="line">                    ExceptionUtils.handleThrowable(letsHopeWeDontGetHere);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stopLatch.countDown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>processKey主要用来处理Selector检查到的通道事件。<br>首先对状态进行判断，如果是close的话，调用cancelledKey进行取消操作；否则对SelectionKey的isValid和KeyAttachment进行检验的话，通过的话，对事件发生的时间进行更新，防止timeout,然后SelectionKey进行读写判断，如果是读或者写事件的话，就对attachment的sendfileData进行非空判断，如果不为空的话，就调用processSendfile方法处理，否则的话就对通道上已经发生的事件进行取消关注，然后调用processSocket进行处理，如果返回false的话，就调用cancelledKey进行取消<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">processKey</span><span class="params">(SelectionKey sk, KeyAttachment attachment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( close ) &#123;</span><br><span class="line">            cancelledKey(sk, SocketStatus.STOP);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( sk.isValid() &amp;&amp; attachment != <span class="keyword">null</span> ) &#123;</span><br><span class="line">            attachment.access();<span class="comment">//make sure we don't time out valid sockets</span></span><br><span class="line">            <span class="keyword">if</span> (sk.isReadable() || sk.isWritable() ) &#123;</span><br><span class="line">                <span class="keyword">if</span> ( attachment.getSendfileData() != <span class="keyword">null</span> ) &#123;</span><br><span class="line">                    processSendfile(sk,attachment, <span class="keyword">false</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> ( isWorkerAvailable() ) &#123;</span><br><span class="line">                        unreg(sk, attachment, sk.readyOps());</span><br><span class="line">                        <span class="keyword">boolean</span> closeSocket = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="comment">// Read goes before write</span></span><br><span class="line">                        <span class="keyword">if</span> (sk.isReadable()) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (!processSocket(attachment, SocketStatus.OPEN_READ, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                                closeSocket = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (!closeSocket &amp;&amp; sk.isWritable()) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (!processSocket(attachment, SocketStatus.OPEN_WRITE, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                                closeSocket = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (closeSocket) &#123;</span><br><span class="line">                            cancelledKey(sk,SocketStatus.DISCONNECT);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        result = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//invalid key</span></span><br><span class="line">            cancelledKey(sk, SocketStatus.ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> ( CancelledKeyException ckx ) &#123;</span><br><span class="line">        cancelledKey(sk, SocketStatus.ERROR);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        log.error(<span class="string">""</span>,t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>processSendfile<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">processSendfile</span><span class="params">(SelectionKey sk, KeyAttachment attachment, <span class="keyword">boolean</span> event)</span> </span>&#123;</span><br><span class="line">    NioChannel sc = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        unreg(sk, attachment, sk.readyOps());</span><br><span class="line">        SendfileData sd = attachment.getSendfileData();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">            log.trace(<span class="string">"Processing send file for: "</span> + sd.fileName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//setup the file channel</span></span><br><span class="line">        <span class="keyword">if</span> ( sd.fchannel == <span class="keyword">null</span> ) &#123;</span><br><span class="line">            File f = <span class="keyword">new</span> File(sd.fileName);</span><br><span class="line">            <span class="keyword">if</span> ( !f.exists() ) &#123;</span><br><span class="line">                cancelledKey(sk,SocketStatus.ERROR);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"resource"</span>) <span class="comment">// Closed when channel is closed</span></span><br><span class="line">            FileInputStream fis = <span class="keyword">new</span> FileInputStream(f);</span><br><span class="line">            sd.fchannel = fis.getChannel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sc = attachment.getSocket();</span><br><span class="line">        WritableByteChannel wc = ((sc <span class="keyword">instanceof</span> SecureNioChannel)?sc:sc.getIOChannel());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sc.getOutboundRemaining()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sc.flushOutbound()) &#123;</span><br><span class="line">                attachment.access();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> written = sd.fchannel.transferTo(sd.pos,sd.length,wc);</span><br><span class="line">            <span class="keyword">if</span> ( written &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                sd.pos += written;</span><br><span class="line">                sd.length -= written;</span><br><span class="line">                attachment.access();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (sd.fchannel.size() &lt;= sd.pos) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Sendfile configured to "</span> +</span><br><span class="line">                            <span class="string">"send more data than was available"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( sd.length &lt;= <span class="number">0</span> &amp;&amp; sc.getOutboundRemaining()&lt;=<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"Send file complete for: "</span>+sd.fileName);</span><br><span class="line">            &#125;</span><br><span class="line">            attachment.setSendfileData(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sd.fchannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( sd.keepAlive ) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                        log.debug(<span class="string">"Connection is keep alive, registering back for OP_READ"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (event) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.add(attachment.getSocket(),SelectionKey.OP_READ);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        reg(sk,attachment,SelectionKey.OP_READ);</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(<span class="string">"Send file connection is being closed"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                cancelledKey(sk,SocketStatus.STOP);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"OP_WRITE for sendfile: "</span> + sd.fileName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (event) &#123;</span><br><span class="line">                add(attachment.getSocket(),SelectionKey.OP_WRITE);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                reg(sk,attachment,SelectionKey.OP_WRITE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span> ( IOException x ) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( log.isDebugEnabled() ) log.debug(<span class="string">"Unable to complete sendfile request:"</span>, x);</span><br><span class="line">        cancelledKey(sk,SocketStatus.ERROR);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;<span class="keyword">catch</span> ( Throwable t ) &#123;</span><br><span class="line">        log.error(<span class="string">""</span>,t);</span><br><span class="line">        cancelledKey(sk, SocketStatus.ERROR);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>processSocket主要是从SocketProcessor缓存队列中取出一个SocketProcessor来处理Socket<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">processSocket</span><span class="params">(KeyAttachment attachment, SocketStatus status, <span class="keyword">boolean</span> dispatch)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (attachment == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        SocketProcessor sc = processorCache.pop();</span><br><span class="line">        <span class="keyword">if</span> ( sc == <span class="keyword">null</span> ) sc = <span class="keyword">new</span> SocketProcessor(attachment, status);</span><br><span class="line">        <span class="keyword">else</span> sc.reset(attachment, status);</span><br><span class="line">        Executor executor = getExecutor();</span><br><span class="line">        <span class="keyword">if</span> (dispatch &amp;&amp; executor != <span class="keyword">null</span>) &#123;</span><br><span class="line">            executor.execute(sc);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sc.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException ree) &#123;</span><br><span class="line">        log.warn(sm.getString(<span class="string">"endpoint.executor.fail"</span>, attachment.getSocket()), ree);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        log.error(sm.getString(<span class="string">"endpoint.process.fail"</span>), t);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>SocketProcessor/run主要是委托给doRun方法调用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    NioChannel socket = ka.getSocket();</span><br><span class="line">    <span class="keyword">if</span> (ka.isUpgraded() &amp;&amp; SocketStatus.OPEN_WRITE == status) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (ka.getWriteThreadLock()) &#123;</span><br><span class="line">            doRun();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (socket) &#123;</span><br><span class="line">            doRun();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>doRun方法主要是将KeyAttachment(即Socket)交给对应的Handler来处理和对status进行更新与修改。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">private void doRun() &#123;</span><br><span class="line">    NioChannel socket = ka.getSocket();</span><br><span class="line">    SelectionKey key = socket.getIOChannel().keyFor(socket.getPoller().getSelector());</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        int handshake = -1;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (key != null) &#123;</span><br><span class="line">                if (socket.isHandshakeComplete() ||</span><br><span class="line">                        status == SocketStatus.STOP) &#123;</span><br><span class="line">                    handshake = 0;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    handshake = socket.handshake(</span><br><span class="line">                            key.isReadable(), key.isWritable());</span><br><span class="line">                    status = SocketStatus.OPEN_READ;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (IOException x) &#123;</span><br><span class="line">            handshake = -1;</span><br><span class="line">            if (log.isDebugEnabled()) log.debug(&quot;Error during SSL handshake&quot;,x);</span><br><span class="line">        &#125; catch (CancelledKeyException ckx) &#123;</span><br><span class="line">            handshake = -1;</span><br><span class="line">        &#125;</span><br><span class="line">        if (handshake == 0) &#123;</span><br><span class="line">            SocketState state = SocketState.OPEN;</span><br><span class="line">            if (status == null) &#123;</span><br><span class="line">                state = handler.process(ka, SocketStatus.OPEN_READ);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                state = handler.process(ka, status);</span><br><span class="line">            &#125;</span><br><span class="line">            if (state == SocketState.CLOSED) &#123;</span><br><span class="line">                close(socket, key, SocketStatus.ERROR);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (handshake == -1 ) &#123;</span><br><span class="line">            close(socket, key, SocketStatus.DISCONNECT);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            ka.getPoller().add(socket,handshake);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (CancelledKeyException cx) &#123;</span><br><span class="line">        socket.getPoller().cancelledKey(key, null);</span><br><span class="line">    &#125; catch (OutOfMemoryError oom) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            oomParachuteData = null;</span><br><span class="line">            log.error(&quot;&quot;, oom);</span><br><span class="line">            socket.getPoller().cancelledKey(key,SocketStatus.ERROR);</span><br><span class="line">            releaseCaches();</span><br><span class="line">        &#125; catch (Throwable oomt) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                System.err.println(oomParachuteMsg);</span><br><span class="line">                oomt.printStackTrace();</span><br><span class="line">            &#125; catch (Throwable letsHopeWeDontGetHere)&#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(letsHopeWeDontGetHere);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (VirtualMachineError vme) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(vme);</span><br><span class="line">    &#125; catch (Throwable t) &#123;</span><br><span class="line">        log.error(&quot;&quot;, t);</span><br><span class="line">        socket.getPoller().cancelledKey(key,SocketStatus.ERROR);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        ka = null;</span><br><span class="line">        status = null;</span><br><span class="line">        //return to cache</span><br><span class="line">        if (running &amp;&amp; !paused) &#123;</span><br><span class="line">            processorCache.push(this);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>process方法是在AbstractConnectionHandler中实现的，它提供了一个模板方法，子类只需要实现相应的钩子函数就可以了。<br>默认实现为Http11ConnectionHandler实现。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SocketState <span class="title">process</span><span class="params">(SocketWrapper&lt;S&gt; wrapper,</span><br><span class="line">            SocketStatus status)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (wrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    S socket = wrapper.getSocket();</span><br><span class="line">    <span class="keyword">if</span> (socket == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Processor&lt;S&gt; processor = connections.get(socket);</span><br><span class="line">    <span class="keyword">if</span> (status == SocketStatus.DISCONNECT &amp;&amp; processor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    wrapper.setAsync(<span class="keyword">false</span>);</span><br><span class="line">    ContainerThreadMarker.set();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (processor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            processor = recycledProcessors.pop();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (processor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            processor = createProcessor();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        initSsl(wrapper, processor);</span><br><span class="line"></span><br><span class="line">        SocketState state = SocketState.CLOSED;</span><br><span class="line">        Iterator&lt;DispatchType&gt; dispatches = <span class="keyword">null</span>;</span><br><span class="line">        do &#123;</span><br><span class="line">            <span class="keyword">if</span> (status == SocketStatus.CLOSE_NOW) &#123;</span><br><span class="line">                processor.errorDispatch();</span><br><span class="line">                state = SocketState.CLOSED;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dispatches != <span class="keyword">null</span>) &#123;</span><br><span class="line">                connections.put(socket, processor);</span><br><span class="line">                DispatchType nextDispatch = dispatches.next();</span><br><span class="line">                <span class="keyword">if</span> (processor.isUpgrade()) &#123;</span><br><span class="line">                    state = processor.upgradeDispatch(</span><br><span class="line">                            nextDispatch.getSocketStatus());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    state = processor.asyncDispatch(</span><br><span class="line">                            nextDispatch.getSocketStatus());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (processor.isComet()) &#123;</span><br><span class="line">                state = processor.event(status);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (processor.isUpgrade()) &#123;</span><br><span class="line">                state = processor.upgradeDispatch(status);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status == SocketStatus.DISCONNECT) &#123;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (processor.isAsync()) &#123;</span><br><span class="line">                state = processor.asyncDispatch(status);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.ASYNC_END) &#123;</span><br><span class="line">                state = processor.asyncDispatch(status);</span><br><span class="line">                getProtocol().endpoint.removeWaitingRequest(wrapper);</span><br><span class="line">                <span class="keyword">if</span> (state == SocketState.OPEN) &#123;</span><br><span class="line">                    state = processor.process(wrapper);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status == SocketStatus.OPEN_WRITE) &#123;</span><br><span class="line">                state = SocketState.LONG;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                state = processor.process(wrapper);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (state != SocketState.CLOSED &amp;&amp; processor.isAsync()) &#123;</span><br><span class="line">                state = processor.asyncPostProcess();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (state == SocketState.UPGRADING) &#123;</span><br><span class="line">                UpgradeToken upgradeToken = processor.getUpgradeToken();</span><br><span class="line">                HttpUpgradeHandler httpUpgradeHandler = upgradeToken.getHttpUpgradeHandler();</span><br><span class="line">                ByteBuffer leftoverInput = processor.getLeftoverInput();</span><br><span class="line">                release(wrapper, processor, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">                processor = createUpgradeProcessor(</span><br><span class="line">                        wrapper, leftoverInput, upgradeToken);</span><br><span class="line">                wrapper.setUpgraded(<span class="keyword">true</span>);</span><br><span class="line">                connections.put(socket, processor);</span><br><span class="line">                <span class="keyword">if</span> (upgradeToken.getInstanceManager() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    httpUpgradeHandler.init((WebConnection) processor);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ClassLoader oldCL = upgradeToken.getContextBind().bind(<span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        httpUpgradeHandler.init((WebConnection) processor);</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        upgradeToken.getContextBind().unbind(<span class="keyword">false</span>, oldCL);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</span><br><span class="line">                getLog().debug(<span class="string">"Socket: ["</span> + wrapper +</span><br><span class="line">                        <span class="string">"], Status in: ["</span> + status +</span><br><span class="line">                        <span class="string">"], State out: ["</span> + state + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (dispatches == <span class="keyword">null</span> || !dispatches.hasNext()) &#123;</span><br><span class="line">                dispatches = wrapper.getIteratorAndClearDispatches();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (state == SocketState.ASYNC_END ||</span><br><span class="line">                state == SocketState.UPGRADING ||</span><br><span class="line">                dispatches != <span class="keyword">null</span> &amp;&amp; state != SocketState.CLOSED);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (state == SocketState.LONG) &#123;</span><br><span class="line">            connections.put(socket, processor);</span><br><span class="line">            longPoll(wrapper, processor);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.OPEN) &#123;</span><br><span class="line">            connections.remove(socket);</span><br><span class="line">            release(wrapper, processor, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.SENDFILE) &#123;</span><br><span class="line">            connections.remove(socket);</span><br><span class="line">            release(wrapper, processor, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.UPGRADED) &#123;</span><br><span class="line">            <span class="keyword">if</span> (status != SocketStatus.OPEN_WRITE) &#123;</span><br><span class="line">                longPoll(wrapper, processor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            connections.remove(socket);</span><br><span class="line">            <span class="keyword">if</span> (processor.isUpgrade()) &#123;</span><br><span class="line">                UpgradeToken upgradeToken = processor.getUpgradeToken();</span><br><span class="line">                HttpUpgradeHandler httpUpgradeHandler = upgradeToken.getHttpUpgradeHandler();</span><br><span class="line">                InstanceManager instanceManager = upgradeToken.getInstanceManager();</span><br><span class="line">                <span class="keyword">if</span> (instanceManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    httpUpgradeHandler.destroy();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ClassLoader oldCL = upgradeToken.getContextBind().bind(<span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        httpUpgradeHandler.destroy();</span><br><span class="line">                        instanceManager.destroyInstance(httpUpgradeHandler);</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        upgradeToken.getContextBind().unbind(<span class="keyword">false</span>, oldCL);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                release(wrapper, processor, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(java.net.SocketException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ContainerThreadMarker.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    connections.remove(socket);</span><br><span class="line">    <span class="keyword">if</span> (processor !=<span class="keyword">null</span> &amp;&amp; !processor.isUpgrade()) &#123;</span><br><span class="line">        release(wrapper, processor, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Request在容器中的流转"><a href="#Request在容器中的流转" class="headerlink" title="Request在容器中的流转"></a><strong>Request在容器中的流转</strong></h2><p>AbstractConnectionHandler的process方法会调用AbstractHttp11Processor的process方法。<br>process方法首先初始化变量，然后进行解析请求头操作，将请求交给adapter的service去处理，请求会从Connector、Engine、Host、Context、Servlet流转进行处理，最后进行结束请求的处理，设置状态码。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SocketState <span class="title">process</span><span class="params">(SocketWrapper&lt;S&gt; socketWrapper)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    RequestInfo rp = request.getRequestProcessor();</span><br><span class="line">    rp.setStage(org.apache.coyote.Constants.STAGE_PARSE);</span><br><span class="line"></span><br><span class="line">    setSocketWrapper(socketWrapper);</span><br><span class="line">    getInputBuffer().init(socketWrapper, endpoint);</span><br><span class="line">    getOutputBuffer().init(socketWrapper, endpoint);</span><br><span class="line"></span><br><span class="line">    keepAlive = <span class="keyword">true</span>;</span><br><span class="line">    comet = <span class="keyword">false</span>;</span><br><span class="line">    openSocket = <span class="keyword">false</span>;</span><br><span class="line">    sendfileInProgress = <span class="keyword">false</span>;</span><br><span class="line">    readComplete = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (endpoint.getUsePolling()) &#123;</span><br><span class="line">        keptAlive = <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        keptAlive = socketWrapper.isKeptAlive();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (disableKeepAlive()) &#123;</span><br><span class="line">        socketWrapper.setKeepAliveLeft(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!getErrorState().isError() &amp;&amp; keepAlive &amp;&amp; !comet &amp;&amp; !isAsync() &amp;&amp;</span><br><span class="line">            upgradeToken == <span class="keyword">null</span> &amp;&amp; !endpoint.isPaused()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            setRequestLineReadTimeout();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!getInputBuffer().parseRequestLine(keptAlive)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (handleIncompleteRequestLineRead()) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (endpoint.isPaused()) &#123;</span><br><span class="line">                response.setStatus(<span class="number">503</span>);</span><br><span class="line">                setErrorState(ErrorState.CLOSE_CLEAN, <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                keptAlive = <span class="keyword">true</span>;</span><br><span class="line">                request.getMimeHeaders().setLimit(endpoint.getMaxHeaderCount());</span><br><span class="line">                <span class="keyword">if</span> (!getInputBuffer().parseHeaders()) &#123;</span><br><span class="line">                    openSocket = <span class="keyword">true</span>;</span><br><span class="line">                    readComplete = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!disableUploadTimeout) &#123;</span><br><span class="line">                    setSocketTimeout(connectionUploadTimeout);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            setErrorState(ErrorState.CLOSE_NOW, e);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(t);</span><br><span class="line">            UserDataHelper.Mode logMode = userDataHelper.getNextMode();</span><br><span class="line">            <span class="keyword">if</span> (logMode != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String message = sm.getString(</span><br><span class="line">                        <span class="string">"http11processor.header.parse"</span>);</span><br><span class="line">                <span class="keyword">switch</span> (logMode) &#123;</span><br><span class="line">                    <span class="keyword">case</span> INFO_THEN_DEBUG:</span><br><span class="line">                        message += sm.getString(</span><br><span class="line">                                <span class="string">"http11processor.fallToDebug"</span>);</span><br><span class="line">                        <span class="comment">//$FALL-THROUGH$</span></span><br><span class="line">                    <span class="keyword">case</span> INFO:</span><br><span class="line">                        getLog().info(message, t);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> DEBUG:</span><br><span class="line">                        getLog().debug(message, t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            response.setStatus(<span class="number">400</span>);</span><br><span class="line">            setErrorState(ErrorState.CLOSE_CLEAN, t);</span><br><span class="line">            getAdapter().log(request, response, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!getErrorState().isError()) &#123;</span><br><span class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_PREPARE);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                prepareRequest();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">                <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</span><br><span class="line">                    getLog().debug(sm.getString(</span><br><span class="line">                            <span class="string">"http11processor.request.prepare"</span>), t);</span><br><span class="line">                &#125;</span><br><span class="line">                response.setStatus(<span class="number">500</span>);</span><br><span class="line">                setErrorState(ErrorState.CLOSE_CLEAN, t);</span><br><span class="line">                getAdapter().log(request, response, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (maxKeepAliveRequests == <span class="number">1</span>) &#123;</span><br><span class="line">            keepAlive = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (maxKeepAliveRequests &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                socketWrapper.decrementKeepAlive() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            keepAlive = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!getErrorState().isError()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                rp.setStage(org.apache.coyote.Constants.STAGE_SERVICE);</span><br><span class="line">                getAdapter().service(request, response);</span><br><span class="line">                <span class="keyword">if</span>(keepAlive &amp;&amp; !getErrorState().isError() &amp;&amp; (</span><br><span class="line">                        response.getErrorException() != <span class="keyword">null</span> ||</span><br><span class="line">                                (!isAsync() &amp;&amp;</span><br><span class="line">                                statusDropsConnection(response.getStatus())))) &#123;</span><br><span class="line">                    setErrorState(ErrorState.CLOSE_CLEAN, <span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                setCometTimeouts(socketWrapper);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedIOException e) &#123;</span><br><span class="line">                setErrorState(ErrorState.CLOSE_NOW, e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (HeadersTooLargeException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (response.isCommitted()) &#123;</span><br><span class="line">                    setErrorState(ErrorState.CLOSE_NOW, e);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    response.reset();</span><br><span class="line">                    response.setStatus(<span class="number">500</span>);</span><br><span class="line">                    setErrorState(ErrorState.CLOSE_CLEAN, e);</span><br><span class="line">                    response.setHeader(<span class="string">"Connection"</span>, <span class="string">"close"</span>); <span class="comment">// <span class="doctag">TODO:</span> Remove</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">                getLog().error(sm.getString(</span><br><span class="line">                        <span class="string">"http11processor.request.process"</span>), t);</span><br><span class="line">                response.setStatus(<span class="number">500</span>);</span><br><span class="line">                setErrorState(ErrorState.CLOSE_CLEAN, t);</span><br><span class="line">                getAdapter().log(request, response, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rp.setStage(org.apache.coyote.Constants.STAGE_ENDINPUT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isAsync() &amp;&amp; !comet) &#123;</span><br><span class="line">            <span class="keyword">if</span> (getErrorState().isError()) &#123;</span><br><span class="line">                getInputBuffer().setSwallowInput(<span class="keyword">false</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                checkExpectationAndResponseStatus();</span><br><span class="line">            &#125;</span><br><span class="line">            endRequest();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rp.setStage(org.apache.coyote.Constants.STAGE_ENDOUTPUT);</span><br><span class="line">        <span class="keyword">if</span> (getErrorState().isError()) &#123;</span><br><span class="line">            response.setStatus(<span class="number">500</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isAsync() &amp;&amp; !comet || getErrorState().isError()) &#123;</span><br><span class="line">            request.updateCounters();</span><br><span class="line">            <span class="keyword">if</span> (getErrorState().isIoAllowed()) &#123;</span><br><span class="line">                getInputBuffer().nextRequest();</span><br><span class="line">                getOutputBuffer().nextRequest();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!disableUploadTimeout) &#123;</span><br><span class="line">            <span class="keyword">if</span>(endpoint.getSoTimeout() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                setSocketTimeout(endpoint.getSoTimeout());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                setSocketTimeout(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rp.setStage(org.apache.coyote.Constants.STAGE_KEEPALIVE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (breakKeepAliveLoop(socketWrapper)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rp.setStage(org.apache.coyote.Constants.STAGE_ENDED);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getErrorState().isError() || endpoint.isPaused()) &#123;</span><br><span class="line">        <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isAsync() || comet) &#123;</span><br><span class="line">        <span class="keyword">return</span> SocketState.LONG;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isUpgrade()) &#123;</span><br><span class="line">        <span class="keyword">return</span> SocketState.UPGRADING;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sendfileInProgress) &#123;</span><br><span class="line">            <span class="keyword">return</span> SocketState.SENDFILE;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (openSocket) &#123;</span><br><span class="line">                <span class="keyword">if</span> (readComplete) &#123;</span><br><span class="line">                    <span class="keyword">return</span> SocketState.OPEN;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> SocketState.LONG;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Adapter是在Http11ConnectionHandler的createProcessor中设置的，创建是在Connector的initInternal方法中创建的。<br>service会将org.apache.coyote.Request和org.apache.coyote.Response对象转为org.apache.catalina.connector.Request和org.apache.catalina.connector.Response对象，在Tomcat容器中流转，使用了外观模式。然后调用postParseRequest找到对应的servlet，然后调用connector.getService().getContainer().getPipeline().getFirst().invoke(request, response)让request和response在容器中流转处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(org.apache.coyote.Request req,</span><br><span class="line">                    org.apache.coyote.Response res)</span></span><br><span class="line">    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    Request request = (Request) req.getNote(ADAPTER_NOTES);</span><br><span class="line">    Response response = (Response) res.getNote(ADAPTER_NOTES);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (request == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        request = connector.createRequest();</span><br><span class="line">        request.setCoyoteRequest(req);</span><br><span class="line">        response = connector.createResponse();</span><br><span class="line">        response.setCoyoteResponse(res);</span><br><span class="line"></span><br><span class="line">        request.setResponse(response);</span><br><span class="line">        response.setRequest(request);</span><br><span class="line"></span><br><span class="line">        req.setNote(ADAPTER_NOTES, request);</span><br><span class="line">        res.setNote(ADAPTER_NOTES, response);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set query string encoding</span></span><br><span class="line">        req.getParameters().setQueryStringEncoding</span><br><span class="line">            (connector.getURIEncoding());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connector.getXpoweredBy()) &#123;</span><br><span class="line">        response.addHeader(<span class="string">"X-Powered-By"</span>, POWERED_BY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> comet = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> async = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> postParseSuccess = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        req.getRequestProcessor().setWorkerThreadName(THREAD_NAME.get());</span><br><span class="line">        postParseSuccess = postParseRequest(req, request, res, response);</span><br><span class="line">        <span class="keyword">if</span> (postParseSuccess) &#123;</span><br><span class="line">            request.setAsyncSupported(connector.getService().getContainer().getPipeline().isAsyncSupported());</span><br><span class="line">            connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (request.isComet()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!response.isClosed() &amp;&amp; !response.isError()) &#123;</span><br><span class="line">                    comet = <span class="keyword">true</span>;</span><br><span class="line">                    res.action(ActionCode.COMET_BEGIN, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (request.getAvailable() || (request.getContentLength() &gt; <span class="number">0</span> &amp;&amp; (!request.isParametersParsed()))) &#123;</span><br><span class="line">                        event(req, res, SocketStatus.OPEN_READ);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    request.setFilterChain(<span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AsyncContextImpl asyncConImpl = (AsyncContextImpl)request.getAsyncContext();</span><br><span class="line">        <span class="keyword">if</span> (asyncConImpl != <span class="keyword">null</span>) &#123;</span><br><span class="line">            async = <span class="keyword">true</span>;</span><br><span class="line">            ReadListener readListener = req.getReadListener();</span><br><span class="line">            <span class="keyword">if</span> (readListener != <span class="keyword">null</span> &amp;&amp; request.isFinished()) &#123;</span><br><span class="line">                ClassLoader oldCL = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    oldCL = request.getContext().bind(<span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (req.sendAllDataReadEvent()) &#123;</span><br><span class="line">                        req.getReadListener().onAllDataRead();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    request.getContext().unbind(<span class="keyword">false</span>, oldCL);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!comet) &#123;</span><br><span class="line">            request.finishRequest();</span><br><span class="line">            response.finishResponse();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!async &amp;&amp; !comet) &#123;</span><br><span class="line">            <span class="keyword">if</span> (postParseSuccess) &#123;</span><br><span class="line">                request.getMappingData().context.logAccess(</span><br><span class="line">                        request, response,</span><br><span class="line">                        System.currentTimeMillis() - req.getStartTime(),</span><br><span class="line">                        <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        req.getRequestProcessor().setWorkerThreadName(<span class="keyword">null</span>);</span><br><span class="line">        AtomicBoolean error = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line">        res.action(ActionCode.IS_ERROR, error);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!comet &amp;&amp; !async || error.get()) &#123;</span><br><span class="line">            request.recycle();</span><br><span class="line">            response.recycle();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            request.clearEncoders();</span><br><span class="line">            response.clearEncoders();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="postParseRequest"><a href="#postParseRequest" class="headerlink" title="postParseRequest"></a><strong>postParseRequest</strong></h4><p>postParseRequest主要是在解析Http Header之后为了request和response对象能够在Tomcat容器中流转进行了处理，然后调用 connector.getService().getMapper().map(serverName, decodedURI,version, request.getMappingData())方法根据MappingData对Engine、Host、Context、servlet进行mapping，找到对应要执行servlet。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">postParseRequest</span><span class="params">(org.apache.coyote.Request req, Request request,</span><br><span class="line">            org.apache.coyote.Response res, Response response)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! req.scheme().isNull()) &#123;</span><br><span class="line">        request.setSecure(req.scheme().equals(<span class="string">"https"</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        req.scheme().setString(connector.getScheme());</span><br><span class="line">        request.setSecure(connector.getSecure());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    String proxyName = connector.getProxyName();</span><br><span class="line">    <span class="keyword">int</span> proxyPort = connector.getProxyPort();</span><br><span class="line">    <span class="keyword">if</span> (proxyPort != <span class="number">0</span>) &#123;</span><br><span class="line">        req.setServerPort(proxyPort);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (proxyName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        req.serverName().setString(proxyName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MessageBytes undecodedURI = req.requestURI();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (undecodedURI.equals(<span class="string">"*"</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (req.method().equalsIgnoreCase(<span class="string">"OPTIONS"</span>)) &#123;</span><br><span class="line">            StringBuilder allow = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            allow.append(<span class="string">"GET, HEAD, POST, PUT, DELETE"</span>);</span><br><span class="line">            <span class="keyword">if</span> (connector.getAllowTrace()) &#123;</span><br><span class="line">                allow.append(<span class="string">", TRACE"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            allow.append(<span class="string">", OPTIONS"</span>);</span><br><span class="line">            res.setHeader(<span class="string">"Allow"</span>, allow.toString());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.setStatus(<span class="number">404</span>);</span><br><span class="line">            res.setMessage(<span class="string">"Not found"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        connector.getService().getContainer().logAccess(</span><br><span class="line">                request, response, <span class="number">0</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MessageBytes decodedURI = req.decodedURI();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (undecodedURI.getType() == MessageBytes.T_BYTES) &#123;</span><br><span class="line">        decodedURI.duplicate(undecodedURI);</span><br><span class="line"></span><br><span class="line">        parsePathParameters(req, request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            req.getURLDecoder().convert(decodedURI, <span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">            res.setStatus(<span class="number">400</span>);</span><br><span class="line">            res.setMessage(<span class="string">"Invalid URI: "</span> + ioe.getMessage());</span><br><span class="line">            connector.getService().getContainer().logAccess(</span><br><span class="line">                    request, response, <span class="number">0</span>, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!normalize(req.decodedURI())) &#123;</span><br><span class="line">            res.setStatus(<span class="number">400</span>);</span><br><span class="line">            res.setMessage(<span class="string">"Invalid URI"</span>);</span><br><span class="line">            connector.getService().getContainer().logAccess(</span><br><span class="line">                    request, response, <span class="number">0</span>, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        convertURI(decodedURI, request);</span><br><span class="line">        <span class="keyword">if</span> (!checkNormalize(req.decodedURI())) &#123;</span><br><span class="line">            res.setStatus(<span class="number">400</span>);</span><br><span class="line">            res.setMessage(<span class="string">"Invalid URI character encoding"</span>);</span><br><span class="line">            connector.getService().getContainer().logAccess(</span><br><span class="line">                    request, response, <span class="number">0</span>, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        decodedURI.toChars();</span><br><span class="line">        CharChunk uriCC = decodedURI.getCharChunk();</span><br><span class="line">        <span class="keyword">int</span> semicolon = uriCC.indexOf(<span class="string">';'</span>);</span><br><span class="line">        <span class="keyword">if</span> (semicolon &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            decodedURI.setChars</span><br><span class="line">                (uriCC.getBuffer(), uriCC.getStart(), semicolon);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MessageBytes serverName;</span><br><span class="line">    <span class="keyword">if</span> (connector.getUseIPVHosts()) &#123;</span><br><span class="line">        serverName = req.localName();</span><br><span class="line">        <span class="keyword">if</span> (serverName.isNull()) &#123;</span><br><span class="line">            res.action(ActionCode.REQ_LOCAL_NAME_ATTRIBUTE, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        serverName = req.serverName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String version = <span class="keyword">null</span>;</span><br><span class="line">    Context versionContext = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> mapRequired = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (mapRequired) &#123;</span><br><span class="line">        connector.getService().getMapper().map(serverName, decodedURI,</span><br><span class="line">                version, request.getMappingData());</span><br><span class="line">        <span class="keyword">if</span> (request.getContext() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            res.setStatus(<span class="number">404</span>);</span><br><span class="line">            res.setMessage(<span class="string">"Not found"</span>);</span><br><span class="line">            Host host = request.getHost();</span><br><span class="line">            <span class="keyword">if</span> (host != <span class="keyword">null</span>) &#123;</span><br><span class="line">                host.logAccess(request, response, <span class="number">0</span>, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String sessionID;</span><br><span class="line">        <span class="keyword">if</span> (request.getServletContext().getEffectiveSessionTrackingModes()</span><br><span class="line">                .contains(SessionTrackingMode.URL)) &#123;</span><br><span class="line">            sessionID = request.getPathParameter(</span><br><span class="line">                    SessionConfig.getSessionUriParamName(</span><br><span class="line">                            request.getContext()));</span><br><span class="line">            <span class="keyword">if</span> (sessionID != <span class="keyword">null</span>) &#123;</span><br><span class="line">                request.setRequestedSessionId(sessionID);</span><br><span class="line">                request.setRequestedSessionURL(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        parseSessionCookiesId(request);</span><br><span class="line">        parseSessionSslId(request);</span><br><span class="line"></span><br><span class="line">        sessionID = request.getRequestedSessionId();</span><br><span class="line"></span><br><span class="line">        mapRequired = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (version != <span class="keyword">null</span> &amp;&amp; request.getContext() == versionContext) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            version = <span class="keyword">null</span>;</span><br><span class="line">            versionContext = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            Context[] contexts = request.getMappingData().contexts;</span><br><span class="line">            <span class="keyword">if</span> (contexts != <span class="keyword">null</span> &amp;&amp; sessionID != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = (contexts.length); i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">                    Context ctxt = contexts[i - <span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">if</span> (ctxt.getManager().findSession(sessionID) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!ctxt.equals(request.getMappingData().context)) &#123;</span><br><span class="line">                            version = ctxt.getWebappVersion();</span><br><span class="line">                            versionContext = ctxt;</span><br><span class="line">                            request.getMappingData().recycle();</span><br><span class="line">                            mapRequired = <span class="keyword">true</span>;</span><br><span class="line">                            request.recycleSessionInfo();</span><br><span class="line">                            request.recycleCookieInfo(<span class="keyword">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mapRequired &amp;&amp; request.getContext().getPaused()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            request.getMappingData().recycle();</span><br><span class="line">            mapRequired = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MessageBytes redirectPathMB = request.getMappingData().redirectPath;</span><br><span class="line">    <span class="keyword">if</span> (!redirectPathMB.isNull()) &#123;</span><br><span class="line">        String redirectPath = URLEncoder.DEFAULT.encode(redirectPathMB.toString());</span><br><span class="line">        String query = request.getQueryString();</span><br><span class="line">        <span class="keyword">if</span> (request.isRequestedSessionIdFromURL()) &#123;</span><br><span class="line">            redirectPath = redirectPath + <span class="string">";"</span> +</span><br><span class="line">                    SessionConfig.getSessionUriParamName(</span><br><span class="line">                        request.getContext()) +</span><br><span class="line">                <span class="string">"="</span> + request.getRequestedSessionId();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (query != <span class="keyword">null</span>) &#123;</span><br><span class="line">            redirectPath = redirectPath + <span class="string">"?"</span> + query;</span><br><span class="line">        &#125;</span><br><span class="line">        response.sendRedirect(redirectPath);</span><br><span class="line">        request.getContext().logAccess(request, response, <span class="number">0</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!connector.getAllowTrace()</span><br><span class="line">            &amp;&amp; req.method().equalsIgnoreCase(<span class="string">"TRACE"</span>)) &#123;</span><br><span class="line">        Wrapper wrapper = request.getWrapper();</span><br><span class="line">        String header = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (wrapper != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String[] methods = wrapper.getServletMethods();</span><br><span class="line">            <span class="keyword">if</span> (methods != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;methods.length; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">"TRACE"</span>.equals(methods[i])) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (header == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        header = methods[i];</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        header += <span class="string">", "</span> + methods[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        res.setStatus(<span class="number">405</span>);</span><br><span class="line">        res.addHeader(<span class="string">"Allow"</span>, header);</span><br><span class="line">        res.setMessage(<span class="string">"TRACE method is not allowed"</span>);</span><br><span class="line">        request.getContext().logAccess(request, response, <span class="number">0</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    doConnectorAuthenticationAuthorization(req, request);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>map方法主要是根据uri进行匹配找到对应的wrapper，wrapper一般与servlet一一对应的，wrapper是在MapperListener\start的时候递归注册host、context、wrapper中注册的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(MessageBytes host, MessageBytes uri, String version, MappingData mappingData)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (host.isNull()) &#123;</span><br><span class="line">		host.getCharChunk().append(defaultHostName);</span><br><span class="line">	&#125;</span><br><span class="line">	host.toChars();</span><br><span class="line">	uri.toChars();</span><br><span class="line">	internalMap(host.getCharChunk(), uri.getCharChunk(), version, mappingData);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">internalMap</span><span class="params">(CharChunk host, CharChunk uri, String version, MappingData mappingData)</span></span><br><span class="line">			<span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (mappingData.host != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	uri.setLimit(-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	MappedHost[] hosts = <span class="keyword">this</span>.hosts;</span><br><span class="line">	MappedHost mappedHost = exactFindIgnoreCase(hosts, host);</span><br><span class="line">	<span class="keyword">if</span> (mappedHost == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (defaultHostName == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		mappedHost = exactFind(hosts, defaultHostName);</span><br><span class="line">		<span class="keyword">if</span> (mappedHost == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	mappingData.host = mappedHost.object;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Context mapping</span></span><br><span class="line">	ContextList contextList = mappedHost.contextList;</span><br><span class="line">	MappedContext[] contexts = contextList.contexts;</span><br><span class="line">	<span class="keyword">int</span> pos = find(contexts, uri);</span><br><span class="line">	<span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> lastSlash = -<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">int</span> uriEnd = uri.getEnd();</span><br><span class="line">	<span class="keyword">int</span> length = -<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">boolean</span> found = <span class="keyword">false</span>;</span><br><span class="line">	MappedContext context = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">while</span> (pos &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		context = contexts[pos];</span><br><span class="line">		<span class="keyword">if</span> (uri.startsWith(context.name)) &#123;</span><br><span class="line">			length = context.name.length();</span><br><span class="line">			<span class="keyword">if</span> (uri.getLength() == length) &#123;</span><br><span class="line">				found = <span class="keyword">true</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (uri.startsWithIgnoreCase(<span class="string">"/"</span>, length)) &#123;</span><br><span class="line">				found = <span class="keyword">true</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (lastSlash == -<span class="number">1</span>) &#123;</span><br><span class="line">			lastSlash = nthSlash(uri, contextList.nesting + <span class="number">1</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			lastSlash = lastSlash(uri);</span><br><span class="line">		&#125;</span><br><span class="line">		uri.setEnd(lastSlash);</span><br><span class="line">		pos = find(contexts, uri);</span><br><span class="line">	&#125;</span><br><span class="line">	uri.setEnd(uriEnd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!found) &#123;</span><br><span class="line">		<span class="keyword">if</span> (contexts[<span class="number">0</span>].name.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">			context = contexts[<span class="number">0</span>];</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			context = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mappingData.contextPath.setString(context.name);</span><br><span class="line"></span><br><span class="line">	ContextVersion contextVersion = <span class="keyword">null</span>;</span><br><span class="line">	ContextVersion[] contextVersions = context.versions;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">int</span> versionCount = contextVersions.length;</span><br><span class="line">	<span class="keyword">if</span> (versionCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">		Context[] contextObjects = <span class="keyword">new</span> Context[contextVersions.length];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; contextObjects.length; i++) &#123;</span><br><span class="line">			contextObjects[i] = contextVersions[i].object;</span><br><span class="line">		&#125;</span><br><span class="line">		mappingData.contexts = contextObjects;</span><br><span class="line">		<span class="keyword">if</span> (version != <span class="keyword">null</span>) &#123;</span><br><span class="line">			contextVersion = exactFind(contextVersions, version);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (contextVersion == <span class="keyword">null</span>) &#123;</span><br><span class="line">		contextVersion = contextVersions[versionCount - <span class="number">1</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	mappingData.context = contextVersion.object;</span><br><span class="line">	mappingData.contextSlashCount = contextVersion.slashCount;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!contextVersion.isPaused()) &#123;</span><br><span class="line">		internalMapWrapper(contextVersion, uri, mappingData);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                    
                        
                    
                    
                        <p>
                            <a href="/2016/05/11/Tomcat请求处理的过程分析/#post-footer" class="postShorten-excerpt_link link">
                                COMMENT AND SHARE
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        <li class="pagination-prev">
            
                <a class="btn btn--default btn--small" href="/archives/page/24/">
            
                <i class="fa fa-angle-left text-base icon-mr"></i>
                    <span>NEWER</span>
            </a>
        </li>
        
        
        <li class="pagination-next">
            <a class="btn btn--default btn--small" href="/archives/page/26/">
                    <span>OLDER</span>
                <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
        </li>
        
        <li class="pagination-number">PAGE 25 OF 45</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2016 冼毅俊. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avatar_01.jpg"/>
        
            <h4 id="about-card-name">冼毅俊</h4>
        
            <h5 id="about-card-bio"><p>Xupter√Java√德桌迷√虐心控√mugen爱好者√音乐杂食党√小说发烧友√基本色√鱼迷√stan√bitch√daydreamer</p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Java研发</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                长安
            </h5>
        
    </div>
</div>

        
<div id="cover" style="background-image:url('/assets/images/background-4.png');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/jquery.js"></script>
<script src="/assets/js/jquery.fancybox.js"></script>
<script src="/assets/js/jquery.fancybox-thumbs.js"></script>
<script src="/assets/js/tranquilpeak.js"></script>
<!--SCRIPTS END-->
<!--PANGU AUTO SPACE-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/3.2.1/pangu.min.js"></script>
<script> pangu.spacingPage(); </script>
<!--PANGU AUTO SPACE END-->



</html>
